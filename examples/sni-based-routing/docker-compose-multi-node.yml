# Docker Compose example for multi-node gateway setup with TLS
# This demonstrates how to run multiple gateway nodes with different certificate approaches
version: '3.8'

services:
  # Kafka broker
  kafka-1:
    image: confluentinc/cp-kafka:7.7.0
    hostname: kafka-1
    container_name: kafka-1
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:29092,PLAINTEXT_HOST://localhost:9092,INTERNAL://kafka-1:44444
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
    depends_on:
      - zookeeper

  # Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.0
    hostname: zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  # SSL certificate generator
  ssl-generator:
    image: confluentinc/cp-kafka:7.7.0
    hostname: ssl-generator
    container_name: ssl-generator
    volumes:
      - ./ssl:/ssl
      - ./generate-ssl.sh:/generate-ssl.sh
    environment:
      CERT_APPROACH: wildcard  # Change to 'node-specific' for node-specific certificates
      GATEWAY_NODE_ID: pod0
      MAX_KAFKA_BROKERS: 3
    command: |
      bash -c "
        chmod +x /generate-ssl.sh
        /generate-ssl.sh
        echo 'SSL generation complete. You can now start the gateway nodes.'
        tail -f /dev/null
      "

  # Gateway Node 0 (pod0)
  gateway-pod0:
    image: confluentinc/cp-kafka:7.7.0  # Replace with actual gateway image
    hostname: gateway-pod0
    container_name: gateway-pod0
    ports:
      - "19092:19092"
    volumes:
      - ./ssl:/etc/gateway
      - ./gateway-wildcard.yaml:/etc/gateway/gateway.yaml  # Use gateway-node-specific.yaml for node-specific approach
    environment:
      GATEWAY_NODE_ID: pod0
    depends_on:
      - kafka-1
      - ssl-generator
    # Command would be replaced with actual gateway startup command
    command: |
      bash -c "
        echo 'Gateway pod0 would start here with:'
        echo 'GATEWAY_NODE_ID=pod0'
        echo 'Config: /etc/gateway/gateway.yaml'
        echo 'Certificates: /etc/gateway/'
        ls -la /etc/gateway/
        tail -f /dev/null
      "

  # Gateway Node 1 (pod1) - for node-specific certificate approach
  gateway-pod1:
    image: confluentinc/cp-kafka:7.7.0  # Replace with actual gateway image
    hostname: gateway-pod1
    container_name: gateway-pod1
    ports:
      - "19093:19092"
    volumes:
      - ./ssl:/etc/gateway
      - ./gateway-node-specific.yaml:/etc/gateway/gateway.yaml
    environment:
      GATEWAY_NODE_ID: pod1
    depends_on:
      - kafka-1
      - ssl-generator
    profiles:
      - multi-node  # Only start with: docker-compose --profile multi-node up
    command: |
      bash -c "
        echo 'Gateway pod1 would start here with:'
        echo 'GATEWAY_NODE_ID=pod1'
        echo 'Config: /etc/gateway/gateway.yaml'
        echo 'Note: For node-specific certificates, generate separate certs for each node'
        tail -f /dev/null
      "

volumes:
  ssl-data: